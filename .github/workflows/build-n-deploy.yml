name: Build and Push to ECR
run-name: Build N Deploy BWT-Sandbox by @${{ github.actor }} ðŸš€


on:
  push:
    branches: [main]
  merge_group:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  build_and_push:
    name: Build and Push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5.0.0
        with:
          audience: sts.amazonaws.com
          aws-region: eu-west-3
          role-to-assume: arn:aws:iam::905418367633:role/bwt-pe-github-auth-role

      - name: ECR Login
        id: ecr-login
        uses:  aws-actions/amazon-ecr-login@v2
    
      - name: Build, Tag and Push to ECR
        env:
            ECR_REGISTRY: ${{ steps.ecr-login.outputs.registry }} 
            ECR_REPOSITORY: bwt-pe
            IMAGE_TAG: ${{ github.sha }}
        run: |
            IMAGE_TAG=$(git rev-parse --short "$GITHUB_SHA")
            docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
            docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
            docker push -a $ECR_REGISTRY/$ECR_REPOSITORY
            
      - name: Cluster Authentication
        run: |
          aws eks update-kubeconfig --name cloudops-default --region us-east-1
          kubectl get ns 
